# 1 概述

**ISO定义的7层OSI模型**
↑7 应用层
↑6 表示层
↑5 会话层
↑4 传输层
↑3 网络层
↑2 链路层
↑1 物理层

**TCP/IP的5层模型**
↑5 应用层           HTTP / DNS / DHCP
↑4 传输层           TCP / UDP / SCTP / DCCP
↑3 网络层(辅助)     ICMP / IGMP / IPsec
↑2 网络层           IP
↑1 链路层           ARP

# 2 Internet地址网络

IPv4常使用点分十进制表示，共32位。
IPv6常使用四个十六进制数块，块间用冒号隔开，共8个块，共128位。其中每个块的前导零不写，全零的块可省略，用::代替。
IPv4映射到IPv6的方法：低32位相同（最后两个块）并用点分十进制表示，紧挨着的前一个块用全f表示，其余块为零。

## IPv4空间划分

可划分为5类，A~E，其中A~C用于Internet单播地址的接口地址和一些特殊情况使用。
通过头几位区分，0为A类，10为B类，110为C类。
D类用于组播使用，E类地址保留。
类|地址范围|高序位|用途|百分比|网络数|主机数
:-:|:-:|:-:|:-:|:-:|:-:|:-:
A|0.0.0.0~127.255.255.255|0|单播/特殊|1/2|2^7|2^24
B|128.0.0.0~191.255.255.255|10|单播/特殊|1/4|2^14|2^16
C|192.0.0.0~223.255.255.255|110|单播/特殊|1/8|2^21|2^8
D|224.0.0.0~239.255.255.255|1110|组播|1/16|N/A|N/A
E|240.0.0.0~255.255.255.255|1111|保留|1/16|N/A|N/A

主机地址中的全零和全一是两个特殊地址，不能分配给主机使用（全零是网络地址，全一是广播地址），其他的才是真正可分配的主机地址。

## 子网

**子网寻址**
显然只划分5类，对于现在的互联网是不够的，而且当一个人得到一个A类的IP地址后，他可能并不需要那么多的主机数，这就造成了浪费。
子网将得到的主机地址继续进行划分，前部分再作为子网的网络地址，后部分作为子网中的主机地址。
例如，在得到一个B类地址后，管理员可以将16位的主机地址继续进行划分，前8位作为子网的网络地址分配给不同的子网，后八位作为子网中的主机地址。于是这个B类地址现在可以支持256个子网，每个子网最多可以有254台主机。
这种划分是只有划分子网的主机和路由器知道的，外部的Internet仍然只是把它看作之前分配的一个B类地址，并通过站点的对应接口地址通信。
**子网掩码**
子网掩码就是一连串的1，可以在IP地址后面加`/x`表示有x位1。通过和IP与获得子网的网络号。
站点之外的路由器做出路由决策只取决于地址的网络号部分，因此，子网掩码只是站点内部的问题。

## 特殊用途地址

前缀|特殊用途|
-|-
0.0.0.0/8|本地网络中的主机。仅作为源IP地址使用。
10.0.0.0/8|专用网络（内联网）地址。不会出现在公共Internet中。
127.0.0.0/8|Internet主机回送地址。通常只用127.0.0.1.
169.254.0.0/16|“链路本地”地址，只用于一条链路，通常自动分配。
172.16.0.0/12|专用网络（内联网）地址。
192.0.0.0/24|IETF协议分配。
192.0.2.0/24|批准用于文档中的TEST-NET-1地址。不会出现在公共Internet中。
192.88.99.0/24|用于6to4中继（任播地址）。
192.168.0.0/16|专用网络（内联网）地址。
198.18.0.0/15|用于基准和性能测试。
198.51.100.0/24|TEST-NET-2地址。
203.0.113.0/24|TEST-NET-3地址。
224.0.0.0/4|IPv4组播地址，仅作为目的IP使用。
240.0.0.0/4|保留空间，除了255.255.255.255
255.255.255.255|本地网络（受限的）广播地址。

# 3 链路层

## 以太网帧格式

前导(7字节)+SFD(1)+DST(6)+SRC(6)+长度或类型(2)+P/Q标签(0/2)+其他标签+上层协议有效载荷(0-1982，通常最大1500字节)+填充(0+)+FCS(4)+载体扩展(可变)
基本帧：64 - 1518字节。
Q标签帧：64 - 1522字节。
信封帧：64 - 2000字节。

传统上，以太网的有效载荷一直是1500字节，它代表以太网的MTU(最大传输单元)。
有效载荷有时会被填充数个0，以保证帧的总长度符合最小长度要求。
帧大小要求最小的帧是64字节，要求数据区（有效载荷）长度（无标签）最小为48字节。当有效载荷较小时，会在末尾填充若干0。

# 4 地址解析协议

网络接口硬件通常有一个主要的硬件地址（以太网或802.11无线接口的48位地址）。由硬件交换的帧需要使用正确的硬件地址定位到正确的接口。一台主机要将一帧发送到另一台主机上，仅知道IP地址是不够的，还要知道主机在网络中的有效硬件地址。
对于TCP/IP网络，ARP提供了一种在IPv4地址和各种网络技术使用的硬件地址之间的映射。
ARP几乎总是用于32位IPv4地址和以太网的48位MAC地址之间的映射。

在一个共享的链路层网段，ARP回想所有主机广播一个ARP请求的以太网帧，“如果目的IP地址是你的地址，回复给我你的MAC地址”。
如果存在，目的主机就会给出一个包含IP地址和MAC地址的应答，同时，记录下发出请求的主机的IP到MAC的映射。
如果不在同一个网段内，ARP会将请求发送给网关，然后网关代为转发。

# 5 Internet

IP提供一种**尽力而为**，**无连接**的数据包交付服务。
也就是说，IP协议不保证数据包的成功到达目的地。
当某些错误发生时，如缓冲区用尽，IP的错误处理方法很简单：丢弃一些数据（通常是最后到达的数据）。所以，任何可靠性都必须依靠上层的协议，如tcp，来保证。
无连接意思是说，IP不会维护网络单元（路由器）中的数据报相关的任何链接状态信息。
就是每个数据报认为是独立的，不能保证多个数据报的交付顺序。

**IPv4**
基本IP头部(20字节) + 可选项(最多40字节) + IP数据（可变长度，最多65515字节）。
![ipv4报文](./Pictures/ipv4.png)
**IPv6**
头部为40字节
![ipv6报文](./Pictures/ipv6.png)

> 字节在网络中传输使用的是网络字节序（大端字节序），即一个4字节的数据传输的顺序是0-7位，8-15位，16-23位，24-31位，也就是所谓的高位优先字节序。
> 计算机的cpu往往使用小端字节序（低位优先字节序）存储二进制整数，所以在网络传输时，需要先将数据转换为网络字节序，再在接受时转换回小端字节序。

## IP头部字段

第1个字段是IP数据报的版本号，占4位，IPv4是4，IPv6是6。

**IPv4**
第2个字段是头部长度（IML）字段，保存IPv4头部中32位字的数量。正常值是5，即只有基本头部的20字节。
第3个字段是区分服务字段，占6位，再加上第4个字段显式拥塞通知字段，2位，用于数据报转发时的特殊处理。
第5个字段是总长度字段(以字节为单位),占16位，通过这个字段和IML，就可以知道数据报的数据部分从哪里开始，以及它的长度。由于16位的限制，数据报的数据部分最多只能有65515字节。
尽管一个IP数据报可以携带65535字节，但是以太网不能携带这么大的数据，会进行分片。
每个分片自身都是一个独立的IP数据报，总长度反映了具体的分片长度。
标识字段就是为了分片的IP数据报不会和其他分片混淆，发送主机通常会在每次发送时将内部计数器加一，并将其复制到标识字段。这个字段是实现分片的关键。
生存期TTL每经过一个路由就减一，直至到0被丢弃，并发送一个ICMP通知发送方该数据报不可达。
协议字段就是标识数据报有效载荷部分的协议类型，如17（UDP）,6(TCP)。
头部检验和只保证头部的正确性，而不保证有效载荷部分的正确性。

**IPv6**
IPv6中，通过扩展头部来实现IPv4中的特殊功能，IPv6头部固定为40字节，然后扩展头部按需添加。
扩展头部或者高层协议头部与IPv6头部构成“级联”关系，也就是IPv6头部紧接着就是扩展头部或者高层协议头部，例如 IPv6->TCP头部->TCP数据，或者IPv6->路由头部->分片头部->TCP头部->TCP数据。反正就是头部都是紧挨着的，看成个链。
其中，下一个头部表示了紧接着的头部类型。

## 分片头部

分片头部用于向目的地发送一个大于路径MTU的数据报。一般，1280字节被认为是整个网络中针对IPv6的链路层最小MTU；在IPv4中，如果数据报大于下一跳的MTU就会被分片。
IPv6的分片扩展头部和IPv4内容基本相同，只是标识符32位提供了更大的分片可能性。
IPv6的分片工作只能由发送者来完成。
IPv6的数据报由两部分组成，不可分片和可分片。
不可分片是指必须由中间节点处理的头部信息，比如路由头部之前的所有头部。
可分片部分是指其他部分，比如上层头部，有效载荷数据等。
分片数据的大小以8字节作为基数。

## IP转发

当主机或者路由器要发送数据报时，首先检查目的地址，将其与转发表中存储的地址进行最长前缀匹配算法。
当目的地址在同一局域网中时，不会经过路由器，而是进行直接交付。
当目的地址不在同一局域网时，会通过NAT地址转换，通过路由器将私网地址转换成公网地址进行转发。

## 移动IP

当主机在网络中的地址不断变化时，前面讨论的方法大概率会失效。移动IP主要基于IPv6。
概念：
移动IP基于一台主机拥有一个“家乡”网络，并可以不时地访问其他网络。
“家乡”网络的传输与一般的网络传输一样。
当主机访问其他网络时，他的IP保持不变，但采用一些特殊的路由和手段，感觉好像还是在家一样。
> 一台移动主机成为一个移动节点MN，与他通信的主机称为通信节点CN。MN被赋予一个由家乡网络的网络前缀获得的IP地址，称为家乡地址；当漫游到另一个网络时，被赋予另一个地址，称为转交地址。
> 当一个CN和一个MN通信时，流量需要经过MN的家乡代理HA来路由。
> HA是一类特殊路由器，被部署在网络基础设施中。MN的家乡地址和转交地址之间的关联称为MN绑定。

# 6 系统配置：DHCP和自动配置

## 动态主机配置协议DHCP

DHCP主要用于为主机指定配置信息，如IP地址、子网掩码、路由IP、DNS服务器IP。
DHCP提供三种分配方式：自动分配、动态分配和手动分配。区别在于地址分配是否基于客户端的身份，以及该地址是否可撤销和更改。最常用的是动态分配，客户端从服务器配置的地址池中获得一个可撤销的IP地址。
动态分配的IP地址是有租期的，使用有效时间结束后，客户机可以申请延长租期。

**DHCP协议操作**
1. 客户机广播一个DHCPDISCOVER消息，请求自己需要一个IP地址
2. 收到广播的服务器响应一个DHCPOFFER消息，并在其中包含可提供的必要配置
3. 客户端决定自己接受哪个服务器的配置，并广播包含该服务器标识符选项的DHCPREQUEST消息，以及IP地址
4. 对应的服务器确定绑定，其他服务器清除与该请求有关的状态
5. 在绑定完成后，服务器再发送一个DHCPACK消息，通知客户机可以使用该IP

# 8 ICMP: Internet控制报文协议

IP协议本身没有办法确认发送数据报是否成功，也无法直接获取诊断信息。
为了解决这个不足，将一个特殊的Internet控制报文协议（ICMP）与IP结合使用。
功能：ICMP负责传递可能需要注意的差错和控制报文。
触发条件：ICMP可能由IP层本身、上层传输协议（TCP、UDP），甚至用户应用等触发执行。
> ICMP不为IP网络提供可靠性，而是表明某些类别的故障和配置信息。
> ICMPv6还负责IPv4的ARP协议相关功能。

## ICMP报文

ICMP报文可分为两类：
* 差错报文：传递有关的IP数据报
* 信息报文：传递有关信息采集和配置

为了限制ICMP报文的发送速率，采用了“令牌桶”的策略。
即，每个“桶”保存了最大数量的“令牌”，每个“令牌”允许一定数量的报文被发送，桶定期被填充新的令牌，每发送一个报文就减去1。

# 10 用户数据报协议和IP分片

